<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Payment</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
<div class="app-shell">
  <div class="card">
    <div class="nav-top" style="text-align:left;margin-bottom:16px">
      <button class="btn-link" onclick="window.location.href='dashboard.html'" style="font-size:14px">← Back to Dashboard</button>
    </div>

    <div class="title">Create Payment</div>
    <div id="alert"></div>
    <div class="form-grid">
      <div class="input-group">
        <div class="input-label">Amount (INR)</div>
        <input id="amount" class="input-field" placeholder="500">
      </div>
      <div class="input-group">
        <div class="input-label">Provider ID</div>
        <input id="providerId" class="input-field" placeholder="provider id">
      </div>
      <div class="input-group">
        <div class="input-label">Service Type</div>
        <select id="serviceType" class="input-field">
          <option value="CONSULTATION">CONSULTATION</option>
        </select>
      </div>
      <div class="input-group">
        <div class="input-label">Idempotency Key (optional)</div>
        <input id="idempotencyKey" class="input-field" placeholder="unique-key-123">
      </div>
    </div>
    <button id="createBtn" class="btn-primary">Create Order</button>
    <div class="footer-text"><button class="btn-link" onclick="location.href='dashboard.html'">Cancel</button></div>
  </div>
</div>

<!-- Success/Fail Modal -->
<div id="resultModal" style="display:none"></div>

<script src="./js/api.js"></script>
<script>
const API_BASE = window.API_BASE || 'http://localhost:3001/v1/api';
const alertEl = document.getElementById('alert');
const createBtn = document.getElementById('createBtn');
const resultModal = document.getElementById('resultModal');

function show(msg, type='error') { 
  alertEl.innerHTML = `<div class="alert alert-${type}">${msg}</div>` 
}

function showModal(success, title, message, redirectUrl = null) {
  const modalClass = success ? 'modal-success' : 'modal-fail';
  const icon = success ? '✓' : '✕';
  const iconClass = success ? 'success-icon' : 'fail-icon';
  resultModal.innerHTML = `
    <div class="modal-overlay" onclick="if(event.target===this) { document.getElementById('resultModal').style.display='none'; ${redirectUrl ? `setTimeout(()=>location.href='${redirectUrl}', 200)` : ''} }">
      <div class="modal-box ${modalClass}">
        <div class="${iconClass}">${icon}</div>
        <div class="modal-title">${title}</div>
        <div class="modal-message">${message}</div>
        <button class="modal-btn" onclick="document.getElementById('resultModal').style.display='none'; ${redirectUrl ? `location.href='${redirectUrl}'` : ''};closeModal()">OK</button>
      </div>
    </div>
  `;
  resultModal.style.display = 'block';
}

function closeModal() {
  resultModal.style.display = 'none';
}

if (!getToken()) location.href='login.html';

createBtn.onclick = async () => {
  const amount = Number(document.getElementById('amount').value);
  const providerId = document.getElementById('providerId').value.trim();
  const serviceType = document.getElementById('serviceType').value;
  let idempotencyKey = document.getElementById('idempotencyKey').value.trim();

  // Validation
  if (!amount) return show('❌ Amount is required');
  if (amount <= 0) return show('❌ Amount must be greater than 0');
  if (!providerId) return show('❌ Provider ID is required');
  if (!serviceType) return show('❌ Service Type is required');

  // Get userId from token
  const payload = decodeToken(getToken());
  const userId = payload && payload.userId;
  if (!userId) return show('❌ User ID not found. Please login again.');

  // Auto-generate idempotency key if not provided
  if (!idempotencyKey) {
    idempotencyKey = `order_${userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    // Store it for reference
    document.getElementById('idempotencyKey').value = idempotencyKey;
  }

  // Show loading state
  createBtn.disabled = true;
  createBtn.innerHTML = '<span class="spinner"></span>Creating Order...';

  try {
    console.debug('Creating order with', { amount, currency: 'INR', providerId, serviceType, idempotencyKey });
    const res = await apiFetch('/payments/create', {
      method: 'POST',
      body: JSON.stringify({ amount, currency: 'INR', description: '', providerId, serviceType, idempotencyKey })
    });
    const data = await res.json();
    console.debug('Create order response', { status: res.status, ok: res.ok, body: data });
    
    if (!res.ok) {
      const errMsg = data.error || data.message || 'Failed to create order';
      console.error('Create order failed', errMsg);
      show('❌ ' + errMsg);
      createBtn.disabled = false;
      createBtn.innerHTML = 'Create Order';
      return;
    }

    // Check if this is a duplicate/cached order
    if (data.data?.isDuplicate) {
      show('⚠️ ' + data.data.message + ' Opening checkout...', 'success');
    }

    // If backend returned razorpay key and orderId, open Razorpay Checkout
    const orderId = data.data?.orderId;
    const razorpayKey = data.data?.razorpayKey;
    const referenceId = data.data?.referenceId;

    if (orderId && razorpayKey) {
      // load checkout script if not already
      const loadRzp = () => new Promise((resolve, reject) => {
        if (window.Razorpay) return resolve();
        const s = document.createElement('script');
        s.src = 'https://checkout.razorpay.com/v1/checkout.js';
        s.onload = () => resolve();
        s.onerror = reject;
        document.head.appendChild(s);
      });

      try {
        await loadRzp();
        const options = {
          key: razorpayKey,
          amount: Math.round(amount * 100), // in paise
          currency: 'INR',
          name: 'Ternapay',
          description: 'Payment',
          order_id: orderId,
          handler: async function(response) {
            // response contains razorpay_payment_id, razorpay_order_id, razorpay_signature
            try {
              createBtn.disabled = true;
              createBtn.innerHTML = '<span class="spinner"></span>Verifying Payment...';
              
              const verifyRes = await apiFetch('/payments/verify', {
                method: 'POST',
                body: JSON.stringify({
                  razorpayOrderId: response.razorpay_order_id,
                  razorpayPaymentId: response.razorpay_payment_id,
                  razorpaySignature: response.razorpay_signature,
                  referenceId
                })
              });
              const vr = await verifyRes.json();
              if (verifyRes.ok) {
                showModal(true, 'Payment Successful!', `Your payment of ₹${amount} has been confirmed and verified. You will be redirected to your payment history.`, 'paymentHistory.html');
              } else {
                const failMsg = vr.message || vr.error || 'Payment verification failed';
                showModal(false, 'Verification Failed', failMsg);
                createBtn.disabled = false;
                createBtn.innerHTML = 'Create Order';
              }
            } catch (e) {
              console.error(e);
              showModal(false, 'Error', 'An error occurred while verifying the payment: ' + e.message);
              createBtn.disabled = false;
              createBtn.innerHTML = 'Create Order';
            }
          },
          modal: {
            ondismiss: function() {
              createBtn.disabled = false;
              createBtn.innerHTML = 'Create Order';
              show('❌ Payment cancelled');
            }
          },
          prefill: {
            email: getUser()?.email || ''
          },
          theme: { color: '#6b21a8' }
        };

        const rzp = new window.Razorpay(options);
        rzp.open();
      } catch (e) {
        console.error('Failed to load Razorpay script', e);
        showModal(false, 'Checkout Error', 'Failed to load Razorpay checkout. Please try again.');
        createBtn.disabled = false;
        createBtn.innerHTML = 'Create Order';
      }

      return;
    }

    show('❌ Order created but checkout details missing');
    createBtn.disabled = false;
    createBtn.innerHTML = 'Create Order';
  } catch (err) {
    console.error(err);
    show('❌ Server error: ' + err.message);
    createBtn.disabled = false;
    createBtn.innerHTML = 'Create Order';
  }
}
</script>
</body>
</html>