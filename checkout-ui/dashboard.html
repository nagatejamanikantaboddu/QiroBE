<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ternapay â€“ Dashboard</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
<div class="container">
  <header class="topbar">
    <div>
      <img src="./logo.png" class="logo-small" alt="logo">
      <span style="font-weight:700;font-size:16px">Ternapay Dashboard</span>
    </div>
    <div id="userInfo"></div>
    <button id="logoutBtn" class="btn-ghost">Logout</button>
  </header>

  <main>
    <section class="card small">
      <h3>ğŸ’³ Create Payment</h3>
      <button onclick="location.href='createPayment.html'" class="btn-primary" style="margin-top:8px;width:100%">+ New Payment</button>
    </section>

    <section class="card">
      <h3>ğŸ“Š Recent Payments</h3>
      <div id="paymentsList" style="margin:0 -20px"></div>
      <button onclick="location.href='paymentHistory.html'" class="btn-link" style="margin-top:12px;display:inline-block">View All Payments â†’</button>
    </section>
  </main>
</div>

<script src="./js/api.js"></script>
<script>
if (!getToken()) { 
  window.location.href = 'login.html';
}

const user = getUser() || {};
const userInfo = document.getElementById('userInfo');
const userDisplay = user.name || user.email || 'User';
userInfo.innerHTML = `Welcome, <strong>${userDisplay}</strong>`;

// Logout
document.getElementById('logoutBtn').onclick = () => { 
  localStorage.removeItem('ternapay_token'); 
  localStorage.removeItem('ternapay_user'); 
  window.location.href='login.html';
};

// Load recent payments (first 5)
(async function loadRecent() {
  const payload = decodeToken(getToken());
  const userId = payload?.userId || user._id;
  
  if (!userId) { 
    document.getElementById('paymentsList').innerHTML = '<div class="alert alert-error">âŒ User ID not found</div>'; 
    return;
  }
  
  try {
    const res = await apiFetch(`/payments/paymenthistory/${userId}`);
    const data = await res.json();
    
    if (!res.ok) {
      console.error('Failed to load payments:', data);
      document.getElementById('paymentsList').innerHTML = '<div class="alert alert-error">âŒ ' + (data.error || 'Failed to load') + '</div>'; 
      return;
    }
    
    const list = (data.data || data || []);
    if (!Array.isArray(list) || list.length === 0) {
      document.getElementById('paymentsList').innerHTML = '<em>ğŸ“­ No payments yet. Start by creating a new payment.</em>';
      return;
    }
    
    renderPayments(list.slice(0, 5));
  } catch (err) {
    console.error('Error loading payments:', err);
    document.getElementById('paymentsList').innerHTML = '<div class="alert alert-error">âŒ Error loading payments: ' + err.message + '</div>';
  }
})();

function renderPayments(list) {
  const el = document.getElementById('paymentsList');
  if (!list || list.length === 0) { 
    el.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">ğŸ“­ No payments yet. Create one to get started.</div>'; 
    return;
  }
  
      // Add column headers
      let headerHtml = `
        <div class="payment-header">
          <div>Txn ID</div>
          <div style="text-align:center">Status</div>
          <div style="text-align:right">Amount</div>
          <div style="text-align:center">Date</div>
          <div style="text-align:center">Time</div>
        </div>
      `;
      
      const rows = list.map(p => {
        const status = (p.status || 'pending').toLowerCase();
        const statusColor = status === 'success' ? '#6ee7b7' : status === 'failed' ? '#ff6b7a' : '#f59e0b';
        const statusIcon = status === 'success' ? 'âœ“' : status === 'failed' ? 'âœ•' : 'â³';
        const dateObj = p.createdAt ? new Date(p.createdAt) : null;
        const dateStr = dateObj ? dateObj.toLocaleDateString() : 'N/A';
        const timeStr = dateObj ? dateObj.toLocaleTimeString() : 'N/A';
        
        return `
          <div class="payment-row">
            <div><strong>${p.referenceId || p.orderId || 'N/A'}</strong></div>
            <div style="color:${statusColor};font-weight:700;text-align:center">${statusIcon} ${status.toUpperCase()}</div>
            <div style="text-align:right">â‚¹${p.amount || 0}</div>
            <div style="color:var(--muted);font-size:12px;text-align:center">${dateStr}</div>
            <div style="color:var(--muted);font-size:12px;text-align:center">${timeStr}</div>
          </div>
        `;
      }).join('');
  
  el.innerHTML = headerHtml + rows;
}
</script>
</body>
</html>